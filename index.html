<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuesta Anónima sobre Estrés</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados para el tema pastel */
        :root {
            --color-primary: #f8c0c8; /* Rosa Pastel */
            --color-secondary: #c0f8e9; /* Menta Pastel */
            --color-background: #fffafa; /* Fondo muy claro */
            --color-text: #4a5568; /* Gris oscuro */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
        }
        .header-bg {
            background-color: var(--color-primary);
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: #4a5568;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #f6a6b0;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: var(--color-secondary);
            color: #4a5568;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background-color: #a6f6df;
            transform: translateY(-1px);
        }
        /* Estilo para los radio buttons (Sí/No) */
        .radio-label {
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        input[type="radio"]:checked + .radio-label {
            background-color: var(--color-primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* Estilo para los campos de resultado que se generan dinámicamente */
        .result-item {
            border-left: 5px solid var(--color-primary);
        }
        .bar-si { background-color: var(--color-primary); }
        .bar-no { background-color: var(--color-secondary); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- URL del Google Apps Script (¡DEBES ACTUALIZAR ESTO!) -->
    <!-- Consulta el archivo instrucciones_apps_script.md para obtener tu URL -->
    <script>
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyT6Oe_7jN2IQYSnF_bX2XnvAlKPPGJjRAT53JNg2RHRCRInk4rCcgU11vEalnJxpcnDA/exec"; // <-- ¡ACTUALIZA ESTA URL!
    </script>


    <!-- Cabecera y Botones de Control -->
    <header class="w-full max-w-lg mb-8 p-4 rounded-xl shadow-lg header-bg flex justify-between items-center">
        <h1 class="text-xl font-bold text-gray-700">Encuesta de Estrés</h1>
        <button id="showResultsBtn" class="btn-secondary px-4 py-2 rounded-lg font-medium shadow-md">
            Mostrar resultados
        </button>
    </header>

    <!-- Contenedor Principal de la Encuesta -->
    <main id="surveyContainer" class="w-full max-w-lg bg-white p-6 md:p-8 rounded-xl shadow-2xl space-y-6">
        <p class="text-center text-lg mb-6 font-semibold text-gray-600">
            Responde de forma anónima a las siguientes preguntas.
        </p>
        
        <form id="stressSurveyForm" class="space-y-6">
            <!-- Pregunta 1 -->
            <div class="border p-4 rounded-xl shadow-sm hover:shadow-md transition duration-300">
                <label class="block text-gray-700 font-medium mb-3">1. ¿Alguna vez te has sentido estresado?</label>
                <div class="flex space-x-4">
                    <input type="radio" id="q1_si" name="q1" value="Sí" required class="hidden">
                    <label for="q1_si" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">Sí</label>
                    <input type="radio" id="q1_no" name="q1" value="No" required class="hidden">
                    <label for="q1_no" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">No</label>
                </div>
            </div>

            <!-- Pregunta 2 -->
            <div class="border p-4 rounded-xl shadow-sm hover:shadow-md transition duration-300">
                <label class="block text-gray-700 font-medium mb-3">2. ¿Con qué frecuencia te has sentido estresado?</label>
                <div class="flex space-x-4">
                    <input type="radio" id="q2_si" name="q2" value="Sí" required class="hidden">
                    <label for="q2_si" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">Sí</label>
                    <input type="radio" id="q2_no" name="q2" value="No" required class="hidden">
                    <label for="q2_no" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">No</label>
                </div>
            </div>
            
            <!-- Pregunta 3 -->
            <div class="border p-4 rounded-xl shadow-sm hover:shadow-md transition duration-300">
                <label class="block text-gray-700 font-medium mb-3">3. ¿Se te ha hecho difícil llevar a cabo una tarea debido a falta de concentración o preocupación?</label>
                <div class="flex space-x-4">
                    <input type="radio" id="q3_si" name="q3" value="Sí" required class="hidden">
                    <label for="q3_si" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">Sí</label>
                    <input type="radio" id="q3_no" name="q3" value="No" required class="hidden">
                    <label for="q3_no" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">No</label>
                </div>
            </div>

            <!-- Pregunta 4 -->
            <div class="border p-4 rounded-xl shadow-sm hover:shadow-md transition duration-300">
                <label class="block text-gray-700 font-medium mb-3">4. ¿Consideras que las relaciones personales te generan estrés?</label>
                <div class="flex space-x-4">
                    <input type="radio" id="q4_si" name="q4" value="Sí" required class="hidden">
                    <label for="q4_si" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">Sí</label>
                    <input type="radio" id="q4_no" name="q4" value="No" required class="hidden">
                    <label for="q4_no" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">No</label>
                </div>
            </div>

            <!-- Pregunta 5 -->
            <div class="border p-4 rounded-xl shadow-sm hover:shadow-md transition duration-300">
                <label class="block text-gray-700 font-medium mb-3">5. ¿Sientes que tienes demasiado quehacer y poco tiempo para lograrlo?</label>
                <div class="flex space-x-4">
                    <input type="radio" id="q5_si" name="q5" value="Sí" required class="hidden">
                    <label for="q5_si" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">Sí</label>
                    <input type="radio" id="q5_no" name="q5" value="No" required class="hidden">
                    <label for="q5_no" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">No</label>
                </div>
            </div>

            <!-- Pregunta 6 -->
            <div class="border p-4 rounded-xl shadow-sm hover:shadow-md transition duration-300">
                <label class="block text-gray-700 font-medium mb-3">6. ¿Cuando te sientes sol@ o estresad@ tienes algún apoyo o te acercas a alguien?</label>
                <div class="flex space-x-4">
                    <input type="radio" id="q6_si" name="q6" value="Sí" required class="hidden">
                    <label for="q6_si" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">Sí</label>
                    <input type="radio" id="q6_no" name="q6" value="No" required class="hidden">
                    <label for="q6_no" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">No</label>
                </div>
            </div>

            <!-- Pregunta 7 -->
            <div class="border p-4 rounded-xl shadow-sm hover:shadow-md transition duration-300">
                <label class="block text-gray-700 font-medium mb-3">7. ¿Consideras que el estrés afecta tu salud física o mental?</label>
                <div class="flex space-x-4">
                    <input type="radio" id="q7_si" name="q7" value="Sí" required class="hidden">
                    <label for="q7_si" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">Sí</label>
                    <input type="radio" id="q7_no" name="q7" value="No" required class="hidden">
                    <label for="q7_no" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">No</label>
                </div>
            </div>

            <!-- Pregunta 8 -->
            <div class="border p-4 rounded-xl shadow-sm hover:shadow-md transition duration-300">
                <label class="block text-gray-700 font-medium mb-3">8. ¿Conoces alguna técnica de manejo del estrés?</label>
                <div class="flex space-x-4">
                    <input type="radio" id="q8_si" name="q8" value="Sí" required class="hidden">
                    <label for="q8_si" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">Sí</label>
                    <input type="radio" id="q8_no" name="q8" value="No" required class="hidden">
                    <label for="q8_no" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">No</label>
                </div>
            </div>

            <!-- Pregunta 9 -->
            <div class="border p-4 rounded-xl shadow-sm hover:shadow-md transition duration-300">
                <label class="block text-gray-700 font-medium mb-3">9. En caso de que sí conozcas alguna, ¿has realizado alguna?</label>
                <div class="flex space-x-4">
                    <input type="radio" id="q9_si" name="q9" value="Sí" required class="hidden">
                    <label for="q9_si" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">Sí</label>
                    <input type="radio" id="q9_no" name="q9" value="No" required class="hidden">
                    <label for="q9_no" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">No</label>
                </div>
            </div>

            <!-- Pregunta 10 -->
            <div class="border p-4 rounded-xl shadow-sm hover:shadow-md transition duration-300">
                <label class="block text-gray-700 font-medium mb-3">10. ¿Te ha ayudado?</label>
                <div class="flex space-x-4">
                    <input type="radio" id="q10_si" name="q10" value="Sí" required class="hidden">
                    <label for="q10_si" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">Sí</label>
                    <input type="radio" id="q10_no" name="q10" value="No" required class="hidden">
                    <label for="q10_no" class="radio-label px-4 py-2 rounded-lg cursor-pointer bg-gray-100 hover:bg-gray-200">No</label>
                </div>
            </div>

            <div class="pt-4">
                <button type="submit" id="submitBtn" class="w-full btn-primary px-6 py-3 rounded-xl font-bold text-lg shadow-lg">
                    Registrar Respuestas
                </button>
            </div>
        </form>
        
        <!-- Contenedor para mensajes de estado -->
        <div id="messageBox" class="text-center mt-4 p-3 rounded-lg hidden"></div>
    </main>
    
    <!-- Contenedor de Resultados (Inicialmente oculto) -->
    <div id="resultsContainer" class="w-full max-w-lg bg-white p-6 md:p-8 rounded-xl shadow-2xl mt-8 hidden">
        <h2 class="text-2xl font-bold mb-6 text-gray-700 border-b pb-2">Resultados de la Encuesta</h2>
        <div id="resultsContent" class="space-y-6">
            <!-- Los resultados se inyectarán aquí -->
        </div>
        <button id="closeResultsBtn" class="w-full mt-6 btn-secondary px-6 py-3 rounded-xl font-bold text-lg shadow-md">
            Cerrar Resultados
        </button>
    </div>

    <!-- Modal para Contraseñas / Alertas -->
    <div id="modalBackdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div id="modalContent" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all">
            <h3 id="modalTitle" class="text-xl font-bold mb-4 text-gray-700"></h3>
            <div id="modalBody"></div>
            <div id="modalFooter" class="mt-6 flex justify-end space-x-3"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('stressSurveyForm');
            const submitBtn = document.getElementById('submitBtn');
            const showResultsBtn = document.getElementById('showResultsBtn');
            const closeResultsBtn = document.getElementById('closeResultsBtn');
            const messageBox = document.getElementById('messageBox');
            const surveyContainer = document.getElementById('surveyContainer');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsContent = document.getElementById('resultsContent');
            const modalBackdrop = document.getElementById('modalBackdrop');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalFooter = document.getElementById('modalFooter');

            // Credenciales de acceso (Solo Atziri)
            const ADMIN_USER = 'Atziri';
            const ADMIN_PASS = 'Atziri123'; // Una contraseña básica

            // --- Funciones de Utilidad ---

            /** Muestra una alerta temporal en el contenedor de mensajes. */
            function showAlert(message, isSuccess = true) {
                messageBox.textContent = message;
                messageBox.className = `text-center mt-4 p-3 rounded-lg font-medium ${isSuccess ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
                messageBox.classList.remove('hidden');
                setTimeout(() => messageBox.classList.add('hidden'), 5000);
            }

            /** Muestra un modal con contenido dinámico. */
            function showModal(title, contentHtml, footerButtons = []) {
                modalTitle.textContent = title;
                modalBody.innerHTML = contentHtml;
                modalFooter.innerHTML = '';
                
                footerButtons.forEach(button => {
                    const btn = document.createElement('button');
                    btn.textContent = button.text;
                    btn.className = button.className || 'btn-secondary px-4 py-2 rounded-lg font-medium shadow-sm';
                    btn.addEventListener('click', button.onClick);
                    modalFooter.appendChild(btn);
                });

                modalBackdrop.classList.remove('hidden');
            }

            /** Oculta el modal. */
            function hideModal() {
                modalBackdrop.classList.add('hidden');
            }

            /** Intenta realizar la petición con reintentos y backoff exponencial. */
            async function fetchWithRetry(url, options = {}, retries = 3, delay = 1000) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (!response.ok) {
                             throw new Error(`Error HTTP: ${response.status}`);
                        }
                        return response;
                    } catch (error) {
                        if (i < retries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                        } else {
                            throw error;
                        }
                    }
                }
            }


            // --- Lógica de Envío de Respuestas (doPost) ---

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                submitBtn.disabled = true;
                submitBtn.textContent = 'Registrando...';

                const formData = new FormData(form);
                const data = {};
                
                // Construir objeto de datos con prefijo 'q' para las preguntas
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }

                const url = new URL(GAS_WEB_APP_URL);
                
                // Convertir el objeto de datos a parámetros de URL para el método GET/POST (usaremos GET con fetch para GAS)
                // Usamos GET con parámetros para simplificar el manejo del lado de Apps Script con e.parameter
                Object.keys(data).forEach(key => url.searchParams.append(key, data[key]));

                try {
                    // Nota: Usamos método GET para la Apps Script Web App simple (doPost puede ser más complejo con FormData)
                    const response = await fetchWithRetry(url.toString(), {
                        method: 'GET', // Usaremos GET en el lado del cliente y GAS lo interpretará en doGet/doPost
                        // Como Apps Script requiere el parámetro 'e' para POST y la URL publicada acepta GET para doGet,
                        // la implementación de GAS usa doGet para recibir los datos de este formulario.
                        // (Ver notas en el archivo google_apps_script.js)
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'SUCCESS') {
                        showAlert('¡Respuestas registradas con éxito! Gracias por tu participación.', true);
                        form.reset(); // Limpiar el formulario
                    } else {
                        throw new Error(result.message || 'Error desconocido al registrar las respuestas.');
                    }

                } catch (error) {
                    console.error('Error al registrar:', error);
                    showAlert('Error al registrar respuestas. Verifica la URL de la Apps Script y la conexión.', false);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Registrar Respuestas';
                }
            });


            // --- Lógica de Resultados (doGet) ---

            /** Muestra el modal de inicio de sesión para Atziri. */
            function showLoginModal() {
                const loginHtml = `
                    <div class="space-y-4">
                        <input type="text" id="usernameInput" placeholder="Usuario" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                        <input type="password" id="passwordInput" placeholder="Contraseña" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                        <p id="loginMessage" class="text-sm text-red-500 hidden"></p>
                    </div>
                `;

                showModal('Acceso a Resultados', loginHtml, [
                    {
                        text: 'Cancelar',
                        className: 'btn-secondary px-4 py-2 rounded-lg font-medium shadow-sm',
                        onClick: hideModal
                    },
                    {
                        text: 'Ingresar',
                        className: 'btn-primary px-4 py-2 rounded-lg font-medium shadow-sm',
                        onClick: handleLogin
                    }
                ]);
            }

            /** Maneja el intento de inicio de sesión. */
            function handleLogin() {
                const username = document.getElementById('usernameInput').value;
                const password = document.getElementById('passwordInput').value;
                const loginMessage = document.getElementById('loginMessage');
                loginMessage.classList.add('hidden');

                if (username === ADMIN_USER && password === ADMIN_PASS) {
                    hideModal();
                    fetchAndDisplayResults();
                } else {
                    loginMessage.textContent = 'Usuario o contraseña incorrectos.';
                    loginMessage.classList.remove('hidden');
                }
            }

            /** Llama a la Apps Script para obtener los resultados y los muestra. */
            async function fetchAndDisplayResults() {
                // Muestra el contenedor de resultados y oculta la encuesta
                surveyContainer.classList.add('hidden');
                resultsContainer.classList.remove('hidden');
                resultsContent.innerHTML = '<p class="text-center text-gray-500">Cargando resultados...</p>';

                try {
                    // Llama al doGet de GAS. El Apps Script usa el mismo endpoint.
                    const url = new URL(GAS_WEB_APP_URL);
                    url.searchParams.append('action', 'getResults'); // Parámetro para indicar al Apps Script que retorne los resultados

                    const response = await fetchWithRetry(url.toString(), {
                        method: 'GET'
                    });
                    
                    const results = await response.json();
                    
                    if (results.status === 'SUCCESS' && results.data) {
                        renderResults(results.data);
                    } else {
                        throw new Error(results.message || 'Error al obtener los datos de resultados.');
                    }

                } catch (error) {
                    console.error('Error al obtener resultados:', error);
                    resultsContent.innerHTML = `<p class="text-center text-red-500 font-medium">
                        Error al cargar. Asegúrate de que la Apps Script esté publicada correctamente.
                    </p>`;
                }
            }

            /** Renderiza los resultados en el DOM. */
            function renderResults(data) {
                resultsContent.innerHTML = ''; // Limpiar contenido anterior
                const totalResponses = data.total;
                
                const questions = [
                    "¿Alguna vez te has sentido estresado?",
                    "¿Con qué frecuencia te has sentido estresado?",
                    "¿Se te ha hecho difícil llevar a cabo una tarea debido a falta de concentración o preocupación?",
                    "¿Consideras que las relaciones personales te generan estrés?",
                    "¿Sientes que tienes demasiado quehacer y poco tiempo para lograrlo?",
                    "¿Cuando te sientes sol@ o estresad@ tienes algún apoyo o te acercas a alguien?",
                    "¿Consideras que el estrés afecta tu salud física o mental?",
                    "¿Conoces alguna técnica de manejo del estrés?",
                    "En caso de que sí conozcas alguna, ¿has realizado alguna?",
                    "¿Te ha ayudado?"
                ];

                questions.forEach((question, index) => {
                    const qKey = `q${index + 1}`;
                    const countSi = data[qKey]?.Sí || 0;
                    const countNo = data[qKey]?.No || 0;
                    const total = countSi + countNo;
                    
                    // Calcula porcentajes
                    const percentSi = total === 0 ? 0 : (countSi / total * 100).toFixed(1);
                    const percentNo = total === 0 ? 0 : (countNo / total * 100).toFixed(1);

                    resultsContent.innerHTML += `
                        <div class="result-item p-4 bg-gray-50 rounded-lg shadow-inner">
                            <p class="font-semibold text-gray-800 mb-2">${index + 1}. ${question}</p>
                            <p class="text-sm text-gray-500 mb-3">Total de respuestas: ${totalResponses} / Respuestas válidas: ${total}</p>
                            
                            <div class="flex items-center space-x-2 text-sm font-medium">
                                <span class="w-10">Sí:</span>
                                <div class="w-full h-6 rounded-full overflow-hidden bg-gray-200">
                                    <div class="bar-si h-full rounded-full flex items-center justify-end px-2" style="width: ${percentSi}%;">
                                        <span class="text-white text-xs">${percentSi}% (${countSi})</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-2 text-sm font-medium mt-1">
                                <span class="w-10">No:</span>
                                <div class="w-full h-6 rounded-full overflow-hidden bg-gray-200">
                                    <div class="bar-no h-full rounded-full flex items-center justify-end px-2" style="width: ${percentNo}%;">
                                        <span class="text-gray-700 text-xs">${percentNo}% (${countNo})</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            // --- Event Listeners ---
            
            showResultsBtn.addEventListener('click', showLoginModal);
            
            closeResultsBtn.addEventListener('click', () => {
                resultsContainer.classList.add('hidden');
                surveyContainer.classList.remove('hidden');
            });
            
            // Inicializa la app
            console.log("Aplicación de encuesta cargada. ¡No olvides actualizar la GAS_WEB_APP_URL!");
        });
    </script>
</body>
</html>
